// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider          = "postgresql"
  url               = env("POSTGRES2_PRISMA_URL") // uses connection pooling
  directUrl         = env("POSTGRES2_URL_NON_POOLING") // uses a direct connection
  shadowDatabaseUrl = env("POSTGRES2_URL_NON_POOLING") // used for migrations
}

generator client {
  provider = "prisma-client-js"
}

// This should be a Host
model User {
  id            String         @id @default(cuid())
  name          String?
  // if you are using Github OAuth, you can get rid of the username attribute (that is for Twitter OAuth)
  username      String?
  gh_username   String?
  email         String?        @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  accounts      Account[]
  sessions      Session[]
  sites         Site[]
  posts         Post[]
  reviews       Review[]
  // stripe_account_id
  stripeAccount StripeAccount? // add relation?
  calendars     Calendar[]
}

model StripeAccount {
  id                        Int     @id @default(autoincrement())
  accountId                 String
  accountEmail              String?
  oauthAccessToken          String
  oauthStripePublishableKey String
  oauthRefreshToken         String
  userId                    String  @unique
  user                      User    @relation(fields: [userId], references: [id])
}

model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  refresh_token_expires_in Int?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  oauth_token_secret       String?
  oauth_token              String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // shouldAllowUnlink?
  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Image {
  id         String   @id @default(cuid())
  url        String
  blurHash   String
  uploadedAt DateTime
  size       String
  fileName   String
  orderIndex Int
  
  siteId String?
  site   Site?   @relation(fields: [siteId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  
  postId String
  post   Post?  @relation(fields: [postId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([siteId])
  @@index([postId])
}

model Post {
  id          String   @id @default(cuid())
  title       String   @db.Text
  description String?  @db.Text
  slug        String   @default(cuid())
  published   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // One to many relations: 
  images       Image[]
  calendars    Calendar[]
  reservations Reservation[]
  reviews      Review[]

  // One to one relations:
  site   Site?   @relation(fields: [siteId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  siteId String?

  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId String?

  locationId String?   @unique
  location   Location? @relation(fields: [locationId], references: [id])

  pricingId String?  @unique
  pricing   Pricing? @relation(fields: [pricingId], references: [id])

  availabilityId String?       @unique
  availability   Availability? @relation(fields: [availabilityId], references: [id])

  propertyDetailsId String?          @unique
  propertyDetails   PropertyDetails? @relation(fields: [propertyDetailsId], references: [id])

  afterBookingInfoId String?           @unique
  afterBookingInfo   AfterBookingInfo? @relation(fields: [afterBookingInfoId], references: [id])

  propertyRulesId String?        @unique
  propertyRules   PropertyRules? @relation(fields: [propertyRulesId], references: [id])

  // Many to many relations: 
  @@unique([slug, siteId])
  @@index([siteId])
  @@index([userId])
}

model Location {
  id        String  @id @default(cuid())
  street    String?
  zip       String?
  city      String?
  state     String?
  country   String?
  longitude String?
  latitude  String?
  radius    Int? // Miles

  post Post?
}

model Pricing {
  id              String @id @default(cuid())
  price           Int
  weekendPrice    Int
  cleaningFee     Int
  weeklyDiscount  Float
  monthlyDiscount Float
  securityDeposit Int
  petFee          Int

  minStay              Int
  maxStay              Int
  advanceNotice        Int // 0 - 7
  sameDayAdvanceNotice Int // 6AM -> Midnight
  preparationTime      Int // 0 -2
  availabilityWindow   Int // 3, 6, 9, 12, 24
  restrictedCheckIn    Int[] // 0 - 6
  restrictedCheckOut   Int[] // 0 - 6

  calendars Calendar[]
  images Image[]

  description   String?       @db.Text
  content       String?       @db.Text
  slug          String        @default(cuid())
  image         String?       @default("https://public.blob.vercel-storage.com/eEZHAoPTOBSYGBE3/hxfcV5V-eInX3jbVUhjAt1suB7zB88uGd1j20b.png") @db.Text
  imageBlurhash String?       @default("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAhCAYAAACbffiEAAAACXBIWXMAABYlAAAWJQFJUiTwAAABfUlEQVR4nN3XyZLDIAwE0Pz/v3q3r55JDlSBplsIEI49h76k4opexCK/juP4eXjOT149f2Tf9ySPgcjCc7kdpBTgDPKByKK2bTPFEdMO0RDrusJ0wLRBGCIuelmWJAjkgPGDSIQEMBDCfA2CEPM80+Qwl0JkNxBimiaYGOTUlXYI60YoehzHJDEm7kxjV3whOQTD3AaCuhGKHoYhyb+CBMwjIAFz647kTqyapdV4enGINuDJMSScPmijSwjCaHeLcT77C7EC0C1ugaCTi2HYfAZANgj6Z9A8xY5eiYghDMNQBJNCWhASot0jGsSCUiHWZcSGQjaWWCDaGMOWnsCcn2QhVkRuxqqNxMSdUSElCDbp1hbNOsa6Ugxh7xXauF4DyM1m5BLtCylBXgaxvPXVwEoOBjeIFVODtW74oj1yBQah3E8tyz3SkpolKS9Geo9YMD1QJR1Go4oJkgO1pgbNZq0AOUPChyjvh7vlXaQa+X1UXwKxgHokB2XPxbX+AnijwIU4ahazAAAAAElFTkSuQmCC") @db.Text
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  published     Boolean       @default(false)
  site          Site?         @relation(fields: [siteId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  siteId        String?
  user          User?         @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId        String?
  reservations  Reservation[]
  location      String // street, zip, city, state, country
  longitude     String
  latitude      String

  instantBooking     Boolean
  petsAllowed        Boolean
  eventsAllowed      Boolean
  smokingAllowed     Boolean
  photographyAllowed Boolean

  quietHoursStart String
  quietHoursEnd   String

  checkInWindowStart String
  checkInWindowEnd   String
  checkoutTime       String

  interactionPreferences String
  additionalRules        String
  afterBookingDirections String

  wifiName             String
  wifiPassword         String
  houseManual          String
  checkInMethod        String
  checkoutInstructions String

  // New fields to include additional features
  propertyType         String // 
  maxGuests            Int?
  bedrooms             Int?
  totalBeds            Int?
  bathrooms            Int?
  checkInTime          String // HH:mm:ss Check-in time for the rental property
  checkOutTime         String // HH:mm:ss Check-out time for the rental property
  amenities            String[] // List of amenities available at the property
  rating               Float? // Average rating based on guest reviews
  reviews              Review[] // List of guest reviews and ratings
  currency             String // Currency in which the price is listed
  availabilityCalendar String? // Availability calendar of the property
  photoGallery         String[] // List of images showcasing the property
  photoGalleryBlurhash String[] @default([])
  additionalServices   String[] // List of additional services offered at the property

  @@unique([slug, siteId])
  @@index([siteId])
  @@index([userId])
}

model Calendar {
  id        String   @id @default(cuid())
  postId    String
  name      String
  url       String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId    String?
  Post      Post     @relation(fields: [postId], references: [id])

  @@index([postId])
  @@index([userId])
}

model Review {
  id        String   @id @default(cuid())
  postId    String
  rating    Float
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId    String?
  Post      Post     @relation(fields: [postId], references: [id])

  @@index([postId])
  @@index([userId])
}

model Site {
  id            String   @id @default(cuid())
  name          String?
  description   String?  @db.Text
  logo          String?  @default("https://public.blob.vercel-storage.com/eEZHAoPTOBSYGBE3/JRajRyC-PhBHEinQkupt02jqfKacBVHLWJq7Iy.png") @db.Text
  font          String   @default("font-cal")
  image         String?  @default("https://public.blob.vercel-storage.com/eEZHAoPTOBSYGBE3/hxfcV5V-eInX3jbVUhjAt1suB7zB88uGd1j20b.png") @db.Text
  imageBlurhash String?  @default("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAhCAYAAACbffiEAAAACXBIWXMAABYlAAAWJQFJUiTwAAABfUlEQVR4nN3XyZLDIAwE0Pz/v3q3r55JDlSBplsIEI49h76k4opexCK/juP4eXjOT149f2Tf9ySPgcjCc7kdpBTgDPKByKK2bTPFEdMO0RDrusJ0wLRBGCIuelmWJAjkgPGDSIQEMBDCfA2CEPM80+Qwl0JkNxBimiaYGOTUlXYI60YoehzHJDEm7kxjV3whOQTD3AaCuhGKHoYhyb+CBMwjIAFz647kTqyapdV4enGINuDJMSScPmijSwjCaHeLcT77C7EC0C1ugaCTi2HYfAZANgj6Z9A8xY5eiYghDMNQBJNCWhASot0jGsSCUiHWZcSGQjaWWCDaGMOWnsCcn2QhVkRuxqqNxMSdUSElCDbp1hbNOsa6Ugxh7xXauF4DyM1m5BLtCylBXgaxvPXVwEoOBjeIFVODtW74oj1yBQah3E8tyz3SkpolKS9Geo9YMD1QJR1Go4oJkgO1pgbNZq0AOUPChyjvh7vlXaQa+X1UXwKxgHokB2XPxbX+AnijwIU4ahazAAAAAElFTkSuQmCC") @db.Text
  subdomain     String?  @unique
  customDomain  String?  @unique
  message404    String?  @default("Blimey! You've found a page that doesn't exist.") @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId        String?
  posts         Post[]
  images        Image[]

  @@index([userId])
}

// check if there are any other payment's for postId with status = (PENDING | SUCCESS) in range of(startDate, endDate)
// model StripePaymentIntent
model Payment {
  id                    String   @id @default(cuid())
  stripePaymentIntentId String   @unique
  postId                String
  startDate             DateTime
  endDate               DateTime
  status                String // PROCESSING, SUCCEEDED, FAILED
  totalPrice            Int
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model Reservation {
  id String @id @default(cuid())

  postId     String
  startDate  DateTime
  endDate    DateTime
  totalPrice Int
  adults     Int
  children   Int
  infants    Int
  pets       Int
  status     String // CONFIRMED, PENDING, CANCELLED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  post Post? @relation(fields: [postId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([postId])
}

model Example {
  id            Int     @id @default(autoincrement())
  name          String?
  description   String? @db.Text
  domainCount   Int?
  url           String?
  image         String? @db.Text
  imageBlurhash String? @db.Text
}
